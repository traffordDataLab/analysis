---
title: "CENSUS 2021: Demographics and Migration"
lang: "en-GB"
output:
  html_document:
    highlight: null
    mathjax: null
    theme: flatly
    css: styles.css
    self_contained: TRUE
    toc: true
    toc_depth: 2
    toc_float: true
    df_print: paged
    includes:
      in_header: head_includes.html
---
<main>
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
library(tidyverse) ;
library(sf) ;
library(RColorBrewer) ;
library(kableExtra); 
library(httr) ; library(readxl)
library(scales) ; 
library(ggiraph)
library(ggpol)

source("https://github.com/traffordDataLab/assets/raw/master/theme/ggplot2/theme_lab.R")


# ggplot2 theme
theme_x <- function () { 
  theme_minimal(base_size = 14, base_family = "Open Sans") %+replace% 
    theme(
      panel.grid.major.x = element_blank(),
      panel.grid.minor = element_blank(),
      plot.title = element_text(size = 16, face = "bold", hjust = 0),
      plot.subtitle = element_text(hjust = 0, margin = margin(9, 0, 9, 0)),
      plot.caption = element_text(size = 12, color = "grey50", hjust = 1, margin = margin(t = 15)),
      axis.title = element_text(size = 10, hjust = 1),
      axis.text.x = element_text(angle = 90, hjust = 1, margin = margin(t = 0)),
      legend.position = "top", 
      legend.justification = "left"
    )
}

```


The ONS has published the demography and migration data of the [CENSUS 2021](https://census.gov.uk) including [population and household estimates](https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/bulletins/populationandhouseholdestimatesenglandandwales/census2021unroundeddata), [households and resident characteristics](https://www.ons.gov.uk/peoplepopulationandcommunity/householdcharacteristics/homeinternetandsocialmediausage/bulletins/householdandresidentcharacteristicsenglandandwales/census2021) and [international migration](https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/internationalmigration/bulletins/internationalmigrationenglandandwales/census2021).

A usual resident is anyone who on Census Day, 21 March 2021 was in the UK and had stayed or intended to stay in the UK for a period of 12 months or more, or had a permanent UK address and was outside the UK and intended to be outside the UK for less than 12 months.

A household is one person living alone or a group of people (not necessarily related) living at the same address who share cooking facilities and share a living room or sitting room or dining area.


<br/>

# Demography and migration

## Population


```{r}

tmp <- tempfile(fileext = ".xlsx")
m <- GET(url = "https://ons-dp-prod-census-publication.s3.eu-west-2.amazonaws.com/TS009_sex_resident_age_91a/UR-ltla%2Bsex%2Bresident_age_91a.xlsx",
    write_disk(tmp))


pop_age_21 <- read_xlsx(tmp, sheet = 2, skip = 0) %>%
    select(area_name = `Lower Tier Local Authorities Label`, ageCode = `Age (91 categories) Code`, sex = `Sex (2 categories) Label`, count = Count) %>%
 filter(area_name== "Trafford") %>%

  mutate(ageband = cut(as.numeric(ageCode),
                       breaks = c(0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,120),
                       labels = c("0-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39",
                                  "40-44","45-49","50-54","55-59","60-64","65-69","70-74",
                                  "75-79","80-84","85-89","90+"),
                       right = FALSE)) %>% 
  group_by(area_name, sex, ageband) %>% 
  summarise(`2021` = sum(count)) %>%
  mutate(sex = ifelse(sex=="Female","Females","Males"))
  

```

```{r}

# trafford_tot <- read_xlsx(tmp, sheet = 4, skip = 6) %>%
#   rename(area_name = `Area name`, all_persons = `All persons`) %>%
#   filter(area_name == "Trafford")
  
age_f_m <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_1414_1.data.csv?date=latest&geography=1941962780&c_sex=0...2&c_age=0...39&measures=20100") 

age_f_m_df <- age_f_m %>%
  select(area_code = GEOGRAPHY_CODE, area_name = GEOGRAPHY_NAME, period = DATE_NAME, sex = C_SEX_NAME, age = C_AGE_NAME, value = OBS_VALUE) %>%
  filter(sex %in%  c("Females", "Males"), !age == "All categories: Age") %>%
  mutate(age = str_replace(age,"Age ", ""), age = str_replace(age," to ", "-")) %>%
  mutate(ageband = case_when(age == "under 1" | age =="1" | age =="2" | age =="3" | age =="4" ~ '0-4',
                          age == "5" | age =="6" | age =="7" | age =="8" | age =="9" ~ '5-9',
                          age == "10" | age =="11" | age =="12" | age =="13" | age =="14" ~ '10-14',
                          age == "15" | age =="16" | age =="17" | age =="18" | age =="19" ~ '15-19',
                          age == "20" | age =="21" | age =="22" | age =="23" | age =="24" ~ '20-24',
                          age == "90 and over" ~ '90+',
                                 TRUE ~ age)) %>%
    group_by(ageband,area_name, sex) %>%
  summarise(`2011` = sum(value)) %>%
  ungroup() %>%
  left_join(pop_age_21 %>% select(ageband, sex, `2021`), by = c("ageband", "sex")) %>%
  group_by(sex) %>%
  mutate(percent_2021 = round(`2021`/sum(`2021`)*100,1),
         ageband = factor(ageband, levels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90+")))

          
```
The number of usual residents in Trafford according to the Census 2021 is 235,052, representing an increment of 3.7% from the Census 2011 when the number of usual residents was 226,578. 

There are 120,644 females (51.33%) and 114,408 males (48.66%) in Trafford according to the Census 2021. Similarly, there were 115,619 female (51.03%) and 110,959 male (48.97%) in 2011.


```{r}

# plot data  ---------------------------
ggplot() +
  geom_bar(aes(ageband, `2021`, group = sex, fill = sex), stat = "identity",
           filter(age_f_m_df, sex == "Females"), alpha = 0.6) +
  geom_bar(aes(ageband, -`2021`, group = sex, fill = sex), stat = "identity",
           filter(age_f_m_df, sex == "Males"), alpha = 0.6) +
  geom_line(aes(ageband, `2011`, group = sex), stat = "identity",
            filter(age_f_m_df,  sex == "Females"), size = 1, colour = "#8E2681", alpha = 1) +
  geom_line(aes(ageband, -`2011`, group = sex), stat = "identity",
            filter(age_f_m_df, sex == "Males"), size = 1, colour = "#5d77a3", alpha = 1) +
  geom_text(aes(ageband, -`2021`-1100, label = paste0(percent_2021,"%"), group = sex), stat = "identity",
            filter(age_f_m_df, sex == "Males"), colour = "#212121", size = 3, fontface = "bold", hjust = 0, nudge_y = 0) +
  geom_text(aes(ageband, `2021` - 10, label = paste0(percent_2021,"%"), group = sex), stat = "identity",
            filter(age_f_m_df, sex == "Females"), colour = "#212121", size = 3, fontface = "bold", hjust = 0, nudge_y = 0) +
  scale_x_discrete() +
  scale_y_continuous(labels = abs, limits = max(age_f_m_df$`2021`) * c(-1.15,1.06), breaks = seq(-10000, 10000, by = 2000)) +
  scale_fill_manual(values = c("#8E2681", "#5d77a3"), labels = c("Female", "Male")) +
  coord_flip() +
  labs(x = NULL, y = NULL,
       title = "Trafford population by sex and age, 2011 and 2021",
       subtitle = "   Male  Female",
       caption = "Census 2011(line), Census 2021(bar)\nSource: ONS  |  @traffordDataLab") +
  theme_lab() +
  theme(panel.grid.major.x = element_line(size = 0.3, color = "#cbcbcb"),
    panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 9, hjust = 0.5),
        axis.text.y = element_text(size = 9),
        axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 16),
        plot.subtitle = element_text(hjust = 0.5, size = 9),
        plot.caption = element_text(hjust = 1, size = 9),
        legend.position = "none")





```

```{r}

#Last updated: `r format(Sys.time(), '%d %B %Y')`
age_data_row_2011 <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_1531_1.data.csv?date=latest&geography=1941962780&c_age=0...101&measures=20100,20301")

age_data_2011 <- age_data_row_2011 %>%
  select(age = C_AGE_NAME, area_name = GEOGRAPHY_NAME, date = DATE, measure = MEASURES_NAME, value = OBS_VALUE) %>%
  filter(!age %in% c("All categories: Age") ) %>%
  mutate(age = str_replace(age,"Age ", ""), age = str_replace(age,"under 1", "0"), age = str_replace(age,"100 and over", "100")) 

age_broad_2011 <- age_data_2011 %>%
  filter(measure == "Value") %>%
  mutate(ageband = cut(as.numeric(age),
                       breaks = c(0,16,65,120),
                       labels = c("Under 16", "16-64", "65 or over"),
                       right = FALSE)) %>%
  group_by(ageband,area_name, date, measure) %>%
  summarise(value = sum(value))
  

age_5_2011 <- age_data_2011 %>%
    mutate(age = as.integer(age),
         ageband = cut(age,
                       breaks = c(0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,120),
                       labels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90+"),
                       right = FALSE)) %>%
    group_by(ageband,area_name,date, measure) %>%
  summarise(value = sum(value))

## 2001 UV004 - Age

age_data_row_2001 <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_1637_1.data.csv?date=latest&geography=1946157089&c_age=0...81&measures=20100")

age_data_2001 <- age_data_row_2001 %>%
  select(age = C_AGE_NAME, area_name = GEOGRAPHY_NAME, date = DATE, measure = MEASURES_NAME, value = OBS_VALUE) %>%
  filter(!age %in% c("All categories: Age") ) %>%
  mutate(age = str_replace(age,"Age ", ""), age = str_replace(age,"under 1", "0"), age = str_replace(age,"100 and over", "100")) 

age_broad_2001 <- age_data_2001 %>%
  mutate(agenum = as.numeric(age)) %>%
  mutate(agenum = ifelse(is.na(agenum),75,agenum)) %>%
  mutate(ageband = cut(as.numeric(agenum),
                       breaks = c(0,16,65,120),
                       labels = c("Under 16", "16-64", "65 or over"),
                       right = FALSE)) %>%
  group_by(ageband,area_name, date, measure) %>%
  summarise(value = sum(value)) 

age_5_2001 <- age_data_2001 %>%
    mutate(ageI = as.integer(age),
         ageband = cut(ageI,
                       breaks = c(0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,120),
                       labels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90+"),
                       right = FALSE)) %>%
  mutate(ageband = if_else(is.na(ageband),age,as.character(ageband)) ) %>%
  mutate(ageband = str_replace(ageband," to ", "-")) %>%
  mutate(ageband = if_else(ageband=="90-94" | ageband=="95-99","90+",as.character(ageband)) ) %>%
    group_by(ageband,area_name,date, measure) %>%
  summarise(value = sum(value)) %>%
  mutate(ageband = factor(ageband, levels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90+")))


## 1991

age_data_row_1991 <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_35_1.data.csv?geography=1946157089&date=latest&cell=201457921,201458177,201458433,201458689,201458945,201459201,201459457,201459713,201459969,201460225,201460481,201460737,201460993,201461249,201461505,201461761,201462017,201462273,201462529,201462785,201463041,201463297&measures=20100")

age_broad_1991 <- age_data_row_1991 %>%
    select(age = CELL_NAME, area_name = GEOGRAPHY_NAME, date = DATE, measure = MEASURES_NAME, value = OBS_VALUE) %>%
  filter(!age %in% c("L02:1 (All ages : Total persons )") ) %>%
  mutate(ageband = gsub(".*ed \\s*| :.*", "\\1", age)) %>%
  mutate(ageband = str_replace(ageband," - ", "-"), ageband = str_replace(ageband," ", "")) %>%
  mutate(ageband = case_when(ageband =="0-4" | ageband =="5-9"|ageband =="10-14"| ageband =="15" ~ 'Under 16',
                             ageband =="65-69"| ageband =="70-74"| ageband =="75-79"| ageband =="80-84"|ageband =="85-89"| ageband =="90& over" ~ '65 or over',
                                 TRUE ~ "16-64")) %>%
  group_by(ageband,area_name, date, measure) %>%
  summarise(value = sum(value)) 

age_5_1991 <- age_data_row_1991 %>%
    select(age = CELL_NAME, area_name = GEOGRAPHY_NAME, date = DATE, measure = MEASURES_NAME, value = OBS_VALUE) %>%
  filter(!age %in% c("L02:1 (All ages : Total persons )") ) %>%
  mutate(ageband = gsub(".*ed \\s*| :.*", "\\1", age)) %>%
  mutate(ageband = str_replace(ageband," - ", "-"), ageband = str_replace(ageband," ", "")) %>%
  mutate(ageband = case_when(ageband =="15" | ageband =="16-17" | ageband =="18-19" ~ '15-19',
                          ageband == "90& over" ~ '90+',
                                 TRUE ~ ageband)) %>%
      group_by(ageband,area_name,date, measure) %>%
  summarise(value = sum(value)) %>%
  mutate(ageband = factor(ageband, levels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90+")))

## 1981

age_data_row_1981 <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_66_1.data.csv?geography=1946157089&date=latest&cell=50,57,64,71,78,85,92,99,106,113,120,127,134,141,148,155,162,169,176,183&measures=20100")

age_broad_1981 <- age_data_row_1981 %>%
    select(age = CELL_NAME, area_name = GEOGRAPHY_NAME, date = DATE, measure = MEASURES_NAME, value = OBS_VALUE) %>%
  filter(!age %in% c("All ages : Total persons") ) %>%
  mutate(ageband = gsub(".*ed \\s*| :.*", "\\1", age)) %>%
  mutate(ageband = str_replace(ageband," - ", "-"), ageband = str_replace(ageband," ", "")) %>%
  mutate(ageband = case_when(ageband =="0-4" | ageband =="5-9"|ageband =="10-14"| ageband =="15" ~ 'Under 16',
                             ageband =="65-69"| ageband =="70-74"| ageband =="75-79"| ageband =="80-84"|ageband =="85-89"| ageband =="90& over" ~ '65 or over',
                                 TRUE ~ "16-64")) %>%
  group_by(ageband,area_name, date, measure) %>%
  summarise(value = sum(value)) 

age_5_1981 <- age_data_row_1981 %>%
    select(age = CELL_NAME, area_name = GEOGRAPHY_NAME, date = DATE, measure = MEASURES_NAME, value = OBS_VALUE) %>%
  filter(!age %in% c("All ages : Total persons") ) %>%
  mutate(ageband = gsub(".*ed \\s*| :.*", "\\1", age)) %>%
  mutate(ageband = str_replace(ageband," - ", "-"), ageband = str_replace(ageband," ", "")) %>%
  mutate(ageband = case_when(ageband =="15" | ageband =="16-19" ~ '15-19',
                                 TRUE ~ ageband)) %>%
      group_by(ageband,area_name,date, measure) %>%
  summarise(value = sum(value)) %>%
  mutate(ageband = factor(ageband, levels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+")))

## 2021

tmp2 <- tempfile(fileext = ".xlsx")
m <- GET(url = "https://ons-dp-prod-census-publication.s3.eu-west-2.amazonaws.com/TS007_resident_age_101a/UR-ltla%2Bresident_age_101a.xlsx",
    write_disk(tmp2))

age_broad_2021 <- read_xlsx(tmp2, sheet = 2) %>%
    select(area_name = `Lower Tier Local Authorities Label`, age = `Age (101 categories) Code`, Value = Count) %>%
  filter(area_name== "Trafford") %>%
  mutate(measure = "Value", date = 2021) %>%
  mutate(ageband = cut(as.numeric(age),
                       breaks = c(0,16,65,120),
                       labels = c("Under 16", "16-64", "65 or over"),
                       right = FALSE)) %>%
  group_by(ageband,area_name, date, measure) %>%
  summarise(value = sum(Value))



age_5_2021 <- read_xlsx(tmp2, sheet = 2) %>%
    select(area_name = `Lower Tier Local Authorities Label`, ageCode = `Age (101 categories) Code`, count = Count) %>%
 filter(area_name== "Trafford") %>%

  mutate(ageband = cut(as.numeric(ageCode),
                       breaks = c(0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,120),
                       labels = c("0-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39",
                                  "40-44","45-49","50-54","55-59","60-64","65-69","70-74",
                                  "75-79","80-84","85-89","90+"),
                       right = FALSE)) %>% 
  group_by(area_name, ageband) %>% 
  summarise(value = sum(count)) %>%
  mutate(date = 2021, measure = "Value")

## timeline

age_5_df <- bind_rows(age_5_1981, age_5_1991, age_5_2001, age_5_2011, age_5_2021) %>%
  mutate(value = round(value,0))

age_broad_df <- bind_rows(age_broad_1981, age_broad_1991, age_broad_2001,age_broad_2011,age_broad_2021) %>%
  mutate(ageband = factor(ageband, levels = c("Under 16", "16-64", '65 or over'))) 

# age_broad <- age_5_df %>%
#   mutate(ageclass = case_when(ageband == "0-4" | ageband =="5-9" | ageband =="10-14" ~ 'Under 15',
#                           ageband == "65-69" | ageband =="70-74" | ageband =="75-79" | ageband =="80-84" | ageband =="85-89" | ageband =="90+" | ageband =="85+" ~ '65 and over',
#                                  TRUE ~ "15-64")) %>%
#         group_by(ageclass,area_name,date, measure) %>%
#   summarise(value = sum(value)) %>%
#   mutate(ageclass = factor(ageclass, levels = c("Under 15", "15-64", '65 and over'))) %>%
#   filter(measure == "Value")

age_cat1 <- age_5_df %>%
  mutate(ageclass = case_when(ageband == "0-4" ~ 'Under 5',
                          ageband =="5-9" | ageband =="10-14" | ageband =="15-19" ~ '5 to 19',
                          ageband =="20-24" | ageband =="25-29" | ageband =="30-34" ~ "20 to 34",
                                 TRUE ~ "Other")) %>%
        group_by(ageclass,area_name,date, measure) %>%
  summarise(value = sum(value)) %>%
  mutate(ageclass = factor(ageclass, levels = c("Under 5", "5 to 19", "20 to 34"))) %>%
  filter(measure == "Value", !is.na(ageclass))

age_cat2 <- age_5_df %>%
  mutate(ageclass = case_when(
                          ageband =="35-39" | ageband =="40-44" | ageband =="45-49" ~ "35 to 49",
                          ageband =="50-54" | ageband =="55-59" | ageband =="60-64" | ageband =="65-69" | ageband =="70-74" ~ '50 to 74',
                          ageband =="75-79" | ageband =="80-84" | ageband =="85-89" | ageband =="90+" | ageband =="85+" ~ '75 and over',
                                 TRUE ~ "Other")) %>%
        group_by(ageclass,area_name,date, measure) %>%
  summarise(value = sum(value)) %>%
  mutate(ageclass = factor(ageclass, levels = c("35 to 49", '50 to 74', '75 and over'))) %>%
  filter(measure == "Value", !is.na(ageclass))


age_time <- bind_rows(age_broad_df, age_cat1,age_cat2 )



```

```{r fig.height=3.5, fig.width=8}
  ggplot(data = age_broad_df, aes(x = date)) +
  geom_col(aes(y = value), fill = "#902082") +
  geom_text(aes(label = scales::comma(round(value)), y = value), vjust = -1, size = 3) +
  scale_x_continuous(breaks = unique(age_broad_df$date), expand = c(0.05, 0)) +
  scale_y_continuous(expand = c(0.005, 0.005), limits = c(0,190000), label=comma) +
  facet_wrap(facets = ~`ageband`, nrow = 1) +
  labs(x = NULL, y = NULL, title = "Trafford's population by broad age groups",
       subtitle = "", caption = "Source: ONS  |  @traffordDataLab", fill = NULL) +
  theme_lab() +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  theme(plot.title = element_text(size=16),
        panel.grid.major.y = element_blank(),
        panel.spacing = unit(1, "lines"),
        strip.text = element_text(face = "plain", hjust = 0.5, vjust = 0),
        axis.text.y = element_blank(),
        legend.position = "none")
  

```

```{r fig.height=3, fig.width=8}
  ggplot(data = age_cat1, aes(x = date)) +
  geom_col(aes(y = value), fill = "#5d77a3") +
  geom_text(aes(label = scales::comma(round(value)), y = value), vjust = -1, size = 3) +
  scale_x_continuous(breaks = unique(age_time$date), expand = c(0.1, 0)) +
  scale_y_continuous(expand = c(0.005, 0.005), limits = c(0,80000), label=comma) +
  facet_wrap(facets = ~`ageclass`, nrow = 1) +
  labs(x = NULL, y = NULL, title = "Trafford's population for specific age groups",
       subtitle = "", caption = NULL, fill = NULL) +
  theme_lab() +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  theme(plot.title = element_text(size=16),
        panel.grid.major.y = element_blank(),
        panel.spacing = unit(0.5, "lines"),
        strip.text = element_text(face = "plain", hjust = 0.5, vjust = 0),
        axis.text.y = element_blank(),
        legend.position = "none")
 

```

```{r fig.height=3.5, fig.width=8}
  ggplot(data = age_cat2, aes(x = date)) +
  geom_col(aes(y = value), fill = "#5d77a3") +
  geom_text(aes(label = scales::comma(round(value)), y = value), vjust = -1, size = 3) +
  scale_x_continuous(breaks = unique(age_time$date), expand = c(0.1, 0)) +
  scale_y_continuous(expand = c(0.005, 0.005), limits = c(0,80000), label=comma) +
  facet_wrap(facets = ~`ageclass`, nrow = 1) +
  labs(x = NULL, y = NULL, title = NULL,
       subtitle = "", caption = "Source: ONS  |  @traffordDataLab", fill = NULL) +
  theme_lab() +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  theme(plot.title = element_text(size=16),
        panel.grid.major.y = element_blank(),
        panel.spacing = unit(0.5, "lines"),
        strip.text = element_text(face = "plain", hjust = 0.5, vjust = 0),
        axis.text.y = element_blank(),
        legend.position = "none")
 

```

<br/>


## Population Density

Trafford has the second lowest increase in population density  in Greater Manchester compared to the 2011 Census at 3.58%. Wigan’s increase was smallest at 3.55% while Salford had the highest at 15.24%. The average increase for all Greater Manchester is 6.61%

```{r}

pop_density_raw <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_143_1.data.csv?date=latest&geography=1941962772...1941962781&rural_urban=0&cell=2&measures=20100")

pop_density_2011 <- pop_density_raw %>%
    select(area_name = GEOGRAPHY_NAME, date = DATE, measure = MEASURES_NAME, value = OBS_VALUE) %>%
  mutate(value = value / .01)

tmp3 <- tempfile(fileext = ".xlsx")
m <- GET(url = "https://ons-dp-prod-census-publication.s3.eu-west-2.amazonaws.com/TS006_population_density/atc-ts-demmig-ur-pd-oa-ltla.xlsx",
    write_disk(tmp3))

pop_density_2021 <- read_xlsx(tmp3, sheet = 2) %>%
    select(area_name = `Lower Tier Local Authorities Label`, value = `Population Density`) %>%
  filter(area_name %in% c("Trafford", "Bolton", "Bury", "Manchester", "Oldham", "Rochdale", "Salford", "Stockport", "Tameside", "Wigan")) %>%
  mutate(measure = "Value", date = 2021)

pop_density <- bind_rows(pop_density_2011, pop_density_2021) %>%
  mutate(date = as.character(date),
  area_name = fct_reorder(factor(area_name), ifelse(date == "2021", value, NA), na.rm = TRUE))

pop_density_change <- pop_density %>%
  pivot_wider(names_from = date, values_from = value) %>%
  mutate(change = round(`2021`*100/`2011`-100,1)) %>%
  mutate()

```

<div class = "row">
<div class = "col-md-8">

```{r fig.height=6}

ggplot(pop_density, aes(value,area_name)) +
  geom_line(color = "grey", size=1) +
  geom_point(aes(color = date), size = 4) +
  scale_x_continuous(label=comma) +
  scale_color_manual(values = c("#5d77a3", "#902082"), 
                     labels = c("2011", "2021")) +
  labs(x = "number of usual residents per square kilometre", y = NULL, title = "Population Density Change", subtitle = "", caption = NULL, colour = NULL) +
  theme_lab() +
  theme(plot.title = element_text(size=20),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(hjust = 0),
        legend.position = "bottom",
        legend.text = element_text(size = 10)) +
  guides(color = guide_legend(nrow = 1))

```

</div>
<div class = "col-md-4">
<br/>
<br/>

```{r warning = FALSE, echo=FALSE}

pop_density_change %>%
  select(-measure) %>%
  arrange(desc(`2021`)) %>% 
  kable(col.names = c("LA", "2011", "2021", "% Change"), format.args = list(big.mark = ",")) %>% 
  kable_styling(font_size = 12, bootstrap_options = "none") %>%
  row_spec(0, bold = T, color = "#757575")

```

</div>
</div>
<div class = "row">
<div class = "col-md-10">

```{r}

gm <- st_read("https://www.trafforddatalab.io/spatial_data/local_authority/2016/gm_local_authority_super_generalised.geojson", quiet = TRUE) 

gm_pdch <-  gm %>%
  left_join(pop_density_change %>% mutate(indicator = "Population density", change = round(change,1)) %>% select(-`2011`,-`2021`), by = "area_name")

gg <- ggplot(gm_pdch) +
  geom_sf_interactive(aes(tooltip = paste0(area_name, "\nChange ", change, "%" ),
              fill = change), color = "#FFFFFF", size = 0.5, alpha = 1) +
   scale_fill_gradient(high = "#48327F",
                             low = "#9FBBD9",
                             na.value = "grey50",
                       n.breaks = 5,
                       breaks = waiver(),
                       guide = guide_legend(keyheight = unit(3, units = "mm"),
                                             keywidth=unit(12, units = "mm"),
                                             label.position = "bottom",
                                             title = "Change (%)",
                                             title.position = 'top',
                                             nrow = 1,
                                            aesthetics = "fill")) +
  coord_sf(crs = st_crs(4326), datum = NA) +
  theme_lab() +
      labs(x = NULL, y = NULL,
       title = "Change in population density from 2011 to 2021",
       subtitle = "GM Local authorities",
       caption = "Contains OS data ©; Crown copyright and database right 2022\nSource: ONS  |  @traffordDataLab") + 
  theme(plot.title = element_text(size=14),
        plot.subtitle = element_text(size=12),
        plot.caption = element_text(size=8, hjust = 1),
        legend.title = element_text(size=8),
        legend.text = element_text(size=8),
        legend.position = "bottom") 

girafe(ggobj = gg,
       options = list(opts_tooltip(use_fill = FALSE, opacity = 1, css = "background-color: #e7e6e1; color: #212121; padding: 0.1em; border-radius: 0.25em;"),
                      opts_toolbar(saveaspng = FALSE),
                      opts_hover(css = "fill-opacity: 1; stroke:white; stroke-opacity: 1; r: 2.5pt;")
                      ))


```
</div>
</div>

## Households

Trafford has the lowest increase in households in Greater Manchester compared to the 2011 Census at 1.89%. Salford had the largest increase at 11.16%. The average increase for all Greater Manchester is 4.37%

```{r}

households_raw <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_605_1.data.csv?date=latest&geography=1946157081...1946157090&rural_urban=0&cell=0&measures=20100")

households_2011 <- households_raw %>%
    select(area_name = GEOGRAPHY_NAME, date = DATE, measure = MEASURES_NAME, value = OBS_VALUE) %>%
  mutate(measure = "Count")

tmp4 <- tempfile(fileext = ".xlsx")
m <- GET(url = "https://ons-dp-prod-census-publication.s3.eu-west-2.amazonaws.com/TS041_households/atc-ts-demmig-hh-ct-oa-ltla.xlsx",
    write_disk(tmp4))

households_2021 <- read_xlsx(tmp4, sheet = 2) %>%
    select(area_name = `Lower Tier Local Authorities Label`, value = `Count`) %>%
  filter(area_name %in% c("Trafford", "Bolton", "Bury", "Manchester", "Oldham", "Rochdale", "Salford", "Stockport", "Tameside", "Wigan")) %>%
  mutate(measure = "Count", date = 2021)


households <- bind_rows(households_2011, households_2021) %>%
  mutate(date = as.character(date),
  area_name = fct_reorder(factor(area_name), ifelse(date == "2021", value, NA), na.rm = TRUE))

households_change <- households %>%
  pivot_wider(names_from = date, values_from = value) %>%
  mutate(change = round(`2021`*100/`2011`-100,1))

```

<div class = "row">
<div class = "col-md-8">
```{r fig.height=6}

ggplot(households, aes(value,area_name)) +
  geom_line(color = "grey", size=1) +
  geom_point(aes(color = date), size = 4) +
  scale_x_continuous(label=comma) +
  scale_color_manual(values = c("#5d77a3", "#902082"), 
                     labels = c("2011", "2021")) +
  labs(x = "households", y = NULL, title = "Number of Households Change", subtitle = "", caption = NULL, colour = NULL) +
  theme_lab() +
  theme(plot.title = element_text(size=20),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(hjust = 0),
        legend.position = "bottom",
        legend.text = element_text(size = 10)) +
  guides(color = guide_legend(nrow = 1))

```
</div>
<div class = "col-md-4">
<br/>
<br/>
```{r warning = FALSE, echo=FALSE}

households_change %>%
  select(-measure) %>%
  arrange(desc(`2021`)) %>% 
  kable(col.names = c("LA", "2011", "2021", "% Change"), format.args = list(big.mark = ",")) %>% 
  kable_styling(font_size = 12, bootstrap_options = "none") %>%
  row_spec(0, bold = T, color = "#757575")

```
</div>
</div>
<div class = "row">
<div class = "col-md-10">

```{r}

gm_hch <-  gm %>%
  left_join(households_change %>% mutate(indicator = "Households", change = round(change,0)) %>% select(-`2011`,-`2021`), by = "area_name")


gg <- ggplot(gm_hch) +
  geom_sf_interactive(aes(tooltip = paste0(area_name, "\nChange ", change, "%"),
                          fill = change), color = "#FFFFFF", size = 0.5, alpha = 1) +
   scale_fill_gradient(high = "#48327F",
                             low = "#9FBBD9",
                             na.value = "grey50",
                       n.breaks = 5,
                       breaks = waiver(),
                       guide = guide_legend(keyheight = unit(3, units = "mm"),
                                             keywidth=unit(12, units = "mm"),
                                             label.position = "bottom",
                                             title = "Change (%)",
                                             title.position = 'top',
                                             nrow = 1,
                                            aesthetics = "fill")) +
  coord_sf(crs = st_crs(4326), datum = NA) +
  theme_lab() +
    labs(x = NULL, y = NULL,
       title = "Change in number of households from 2011 to 2021",
       subtitle = "GM Local authorities",
       caption = "Contains OS data ©; Crown copyright and database right 2022\nSource: ONS  |  @traffordDataLab") +
  theme(plot.title = element_text(size=14),
        plot.subtitle = element_text(size=12),
        plot.caption = element_text(size=8, hjust = 1),
        legend.title = element_text(size=8),
        legend.text = element_text(size=8),
        legend.position = "bottom") 
 
girafe(ggobj = gg,
       options = list(opts_tooltip(use_fill = FALSE, opacity = 1, css = "background-color: #e7e6e1; color: #212121; padding: 0.1em; border-radius: 0.25em;"),
                      opts_toolbar(saveaspng = FALSE),
                      opts_hover(css = "fill-opacity: 1; stroke:white; stroke-opacity: 1; r: 2.5pt;")
                      ))



```
</div>
</div>

## Household composition

The most common household composition in Trafford according to the 2021 Census were 2-people households which represented 31.3% of all households, followed closely by one-person households representing 29.5%.
There was a slight increment for both 2-people household with 32.9% and one-person household with 29.8% from the 2011 Census.

According to the 2021 Census, single family households with dependent children represented 30.2% of Trafford households, single family households where all children are non-dependent(adult children) represented 11% of Trafford households, and single family households with no children represented 15.1% of Trafford households, according to the 2021 Census.

<div class = "row">
<div class = "col-md-9">

```{r}

lookup <- read_csv("https://houseofcommonslibrary.github.io/msoanames/MSOA-Names-Latest.csv") %>%
  filter(Laname=="Trafford")


w_dep_ch_raw <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_2023_1.data.csv?date=latest&geography=637535406...637535433,645922849&c2021_hhcomp_15=0,5,8,10,13&measures=20100,20301") %>%
  select(date = DATE, area_name = GEOGRAPHY_NAME, category = C2021_HHCOMP_15_NAME, measure = MEASURES_NAME, value = OBS_VALUE)

w_dep_ch_raw_2011 <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_605_1.data.csv?date=latest&geography=1245709510...1245709537,1946157089&rural_urban=0&cell=5,8,10,12&measures=20100,20301") %>%
  select(date = DATE, area_name = GEOGRAPHY_NAME, category = CELL_NAME, measure = MEASURES_NAME, value = OBS_VALUE)

w_dep_ch_tool <- bind_rows(w_dep_ch_raw, w_dep_ch_raw_2011) %>%
  pivot_wider(names_from = "date", values_from = "value") %>%
  mutate(change = `2021`-`2011`) %>%
  mutate(pchange = round(change*100/`2011`,0)) %>%
  select(category, change, pchange) 

w_dep_ch_raw_To_Traf <- bind_rows(w_dep_ch_raw, w_dep_ch_raw_2011) %>%
  filter(category != "Total") %>%
  group_by(date,area_name, measure) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  left_join(lookup %>% select(msoa11nm,msoa11hclnm), by = c(area_name = "msoa11nm")) %>%
  mutate(area_name = msoa11hclnm) %>%
  select(-msoa11hclnm) %>%
  mutate(area_name = ifelse(is.na(area_name),"Trafford", area_name)) 

w_dep_ch_tool <- w_dep_ch_raw_To_Traf %>%
  pivot_wider(names_from = "date", values_from = "value") %>%
  mutate(change = round(`2021`-`2011`,1)) %>%
  select(area_name, measure, change) %>%
  filter(measure == "Percent")

w_dep_ch_To_Traf <- w_dep_ch_raw_To_Traf %>%
  pivot_wider(names_from = measure, values_from = value) %>%
  left_join(w_dep_ch_tool, by = c("area_name")) %>%
  mutate(tooltip = ifelse(date == 2021,
                          paste0("<strong>", area_name,"</strong><br/>",
      "<strong>", "Year: </strong>", date, "<br/>",
     Percent, "% (", Value, " households)<br/>", 
    "<strong>", "Change from 2011: </strong><br/>",
    change, "%<br/>"),
    paste0("<strong>", area_name,"</strong><br/>",
      "<strong>", "Year: </strong>", date, "<br/>",
     Percent, "% (", Value, " households)<br/>"))) %>%
    mutate(area_name = fct_reorder(factor(area_name), ifelse(date == 2021, Percent, NA), na.rm = TRUE),
         area_name = fct_relevel(factor(area_name), "Trafford"))


```

```{r}
gg <- ggplot(w_dep_ch_To_Traf, aes(Percent, area_name)) +
  geom_line(color = "grey", size=1) +
  geom_point_interactive(aes(tooltip = tooltip, color = as.character(date)), size = 3) +
    scale_color_manual(values = c("#5d77a3", "#902082"), 
                     labels = c("2011", "2021")) +
  scale_x_continuous(limits = c(0,40)) +
    labs(x = "Percent", y = NULL, title = "Households with dependent children", subtitle = "Trafford MSOAs", caption = "*Interactive plot. Source: ONS  |  @traffordDataLab", colour = NULL) +
  theme_lab() +
  theme(plot.title = element_text(size=14),
        plot.subtitle = element_text(size=12),
        plot.caption = element_text(size=8, hjust = 1),
        legend.title = element_text(size=8),
        legend.text = element_text(size=8),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(hjust = 0, size=9),
        axis.title.x = element_text(size=9),
        axis.text.x = element_text(size=9)) +
  guides(color = guide_legend(nrow = 1))
  
girafe(ggobj = gg, height_svg = 6.5,
       options = list(opts_tooltip(use_fill = FALSE, opacity = 1, css = "background-color: #e7e6e1; color: #212121; padding: 0.1em; border-radius: 0.25em;"),
                      opts_toolbar(saveaspng = FALSE),
                      opts_hover(css = "fill-opacity: 1; stroke:white; stroke-opacity: 1; r: 2.5pt;")
                      ))

```
</div>
</div>

One person households aged 66 years and over represented 13.3% of Trafford households, while 16.2% represented other one person households, making the total of one person households 29.5% of all households in Trafford according to the 2021 Census.

<div class = "row">
<div class = "col-md-9">
```{r}

hou_size <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_2037_1.data.csv?date=latest&geography=645922849&c2021_hhsize_10=2...9&measures=20100,20301") %>%
  filter(MEASURES_NAME == "Percent") 

hou_ch_2021 <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_2023_1.data.csv?date=latest&geography=645922849&c2021_hhcomp_15=0,1001,1,2,1002,3,1003,4...6,1004,7...9,1005,10,11,1006,12,1007,13,14&measures=20100,20301") %>%
  filter(MEASURES_NAME == "Percent") %>%
  select(category = C2021_HHCOMP_15_NAME, value = OBS_VALUE)

hushol_onep_raw <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_2023_1.data.csv?date=latest&geography=637535406...637535433,645922849&c2021_hhcomp_15=0...2&measures=20100,20301")

hushol_onep <- hushol_onep_raw %>%
  select(date = DATE, area_name = GEOGRAPHY_NAME, category = C2021_HHCOMP_15_NAME, measure = MEASURES_NAME, value = OBS_VALUE) %>%
  left_join(lookup%>%select(msoa11nm,msoa11hclnm), by = c(area_name = "msoa11nm")) %>%
  mutate(area_name = msoa11hclnm) %>%
  select(-msoa11hclnm) %>%
  mutate(categoryb = gsub("One person household: ", "", category)) %>%
  mutate(area_name = ifelse(is.na(area_name),"Trafford", area_name)) 

onep_66o <- hushol_onep %>%
  filter(categoryb =="Aged 66 years and over") %>%
    mutate(area_name = fct_reorder(factor(area_name), ifelse(measure == "Percent", value, NA), na.rm = TRUE),
         area_name = fct_relevel(factor(area_name), "Trafford"))%>%
  pivot_wider(names_from = measure, values_from = value) %>%
  mutate(tooltip = paste0("<strong>", area_name,"</strong><br/>",
      "<strong>", "Households: </strong>", Value, "<br/>",
    "<strong>", "Percent: </strong>", Percent, "<br/>"))

onep_oth <- hushol_onep %>%
  filter(categoryb =="Other") %>%
    mutate(area_name = fct_reorder(factor(area_name), ifelse(measure == "Percent", value, NA), na.rm = TRUE),
         area_name = fct_relevel(factor(area_name), "Trafford"))
```

```{r}

gg <- ggplot() +
  geom_point_interactive(data = onep_66o, aes(Percent, area_name, tooltip = tooltip), size = 3, colour = "#902082") +
  scale_x_continuous(limits = c(0,20)) +
    labs(x = "Percent", y = NULL, title = "One person household aged 66+", subtitle = "Trafford MSOAs,2021", caption = "*Interactive plot. Source: ONS  |  @traffordDataLab", colour = NULL) +
  theme_lab() +
  theme(plot.title = element_text(size=14),
        plot.subtitle = element_text(size=12),
        plot.caption = element_text(size=8, hjust = 1),
        legend.title = element_text(size=8),
        legend.text = element_text(size=8),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(hjust = 0, size=9),
        axis.title.x = element_text(size=9),
        axis.text.x = element_text(size=9)) +
  guides(color = guide_legend(nrow = 1))
  
girafe(ggobj = gg, height_svg = 6,
       options = list(opts_tooltip(use_fill = FALSE, opacity = 1, css = "background-color: #e7e6e1; color: #212121; padding: 0.1em; border-radius: 0.25em;"),
                      opts_toolbar(saveaspng = FALSE),
                      opts_hover(css = "fill-opacity: 1; stroke:white; stroke-opacity: 1; r: 2.5pt;")
                      ))

  

```
</div>

</div>

## International Migration

Non-UK born people represented 14.9% (35,022) of Trafford residents according to the 2021 Census, a 3.7% growth from the 2011 Census when 11.2% of Trafford residents were born outside of the UK.

2,130 non-UK born Trafford residents, arrived to the UK from the start of 2020 to the 2021 Census day. They represent 0.9% of the total Trafford residents and 6.1% of the total non-UK born Trafford residents.


<div class = "row">
<div class = "col-md-9">

```{r}

year_arrive <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_2035_1.data.csv?date=latest&geography=645922849&c2021_arruk_13=0...12&measures=20100,20301") %>%
  select(date = DATE, area_name = GEOGRAPHY_NAME, category = C2021_ARRUK_13_NAME, measure = MEASURES_NAME, value = OBS_VALUE)

cob_t <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_2024_1.data.csv?date=latest&geography=645922849&c2021_cob_12=0,1001,7...11&measures=20100,20301") %>%
  select(date = DATE, area_name = GEOGRAPHY_NAME, category = C2021_COB_12_NAME, measure = MEASURES_NAME, value = OBS_VALUE)


cobirth_raw <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_2032_1.data.csv?date=latest&geography=645922849&c2021_cob_58=7...12,14...16,18,22,23,25...28,31,32,34,35,37...41,43...45,48,49,53,55,56&measures=20100,20301") %>%
  select(date = DATE, area_name = GEOGRAPHY_NAME, category = C2021_COB_58_NAME, measure = MEASURES_NAME, value = OBS_VALUE)

cobirth <- cobirth_raw %>%
    mutate(category = gsub('.*\\: ', '', category)) %>%
  mutate(category = gsub("\\s*\\([^\\)]+\\)","", category)) %>%
  filter(measure=="Value")

cobirth_raw_2011 <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_524_1.data.csv?date=latest&geography=1946157089&rural_urban=0&cell=13,17...21,24...26,29,34,35,38...41,46,49,50,53...56,59,64,69,74&measures=20100") %>%
  select(date = DATE, area_name = GEOGRAPHY_NAME, category = CELL_NAME, measure = MEASURES_NAME, value = OBS_VALUE)
  
cobirth_2011 <- cobirth_raw_2011 %>%
    mutate(category = gsub('.*\\: ', '', category)) %>%
  mutate(category = gsub("\\s*\\([^\\)]+\\)","", category))

cobirth_tool <- bind_rows(cobirth, cobirth_2011) %>%
  pivot_wider(names_from = "date", values_from = "value") %>%
  mutate(change = `2021`-`2011`) %>%
  mutate(pchange = round(change*100/`2011`,0)) %>%
  select(category, change, pchange) 

cobirth_p <- bind_rows(cobirth_2011,cobirth) %>%
  left_join(cobirth_tool, by = "category") %>%
  filter(category %in% pull(arrange(filter(., value > 200 & date == 2021), value),category)) %>%
  mutate(category = ordered(category, levels = pull(arrange(filter(., date == 2021), value),category))) %>%
  mutate(date = as.character(date)) %>%
  mutate(tooltip = ifelse(date == 2021,
                          paste0("<strong>", category,"</strong><br/>",
      "<strong>", "Year: </strong>", date, "<br/>",
    "<strong>", "Residents: </strong>", value, "<br/>",
    "<strong>", "Change from 2011: </strong><br/>",
    change, " residents (", pchange, "%)<br/>"),
    paste0("<strong>", category,"</strong><br/>",
      "<strong>", "Year: </strong>", date, "<br/>",
    "<strong>", "Residents: </strong>", value, "<br/>")))

```

```{r}

gg <- ggplot(cobirth_p, aes(value,category)) +
  geom_line(color = "grey", size=1) +
  geom_point_interactive(aes(tooltip = tooltip, color = date), size = 3) +
  scale_x_continuous(label=comma) +
  scale_color_manual(values = c("#5d77a3", "#902082"), 
                     labels = c("2011", "2021")) +
  labs(x = "residents", y = NULL, title = "Country of birth Change", subtitle = "Trafford residents born outside the UK by country", caption = "200 residents or more born in country\n*Interactive plot. Source: ONS  |  @traffordDataLab", colour = NULL) +
  theme_lab() +
  theme(plot.title = element_text(size=14),
        plot.subtitle = element_text(size=12),
        plot.caption = element_text(size=8, hjust = 1),
        legend.title = element_text(size=8),
        legend.text = element_text(size=8),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(hjust = 0, size=9),
        axis.title.x = element_text(size=9),
        axis.text.x = element_text(size=9)) +
  guides(color = guide_legend(nrow = 1))
  
girafe(ggobj = gg, height_svg = 7,
       options = list(opts_tooltip(use_fill = FALSE, opacity = 1, css = "background-color: #e7e6e1; color: #212121; padding: 0.1em; border-radius: 0.25em;"),
                      opts_toolbar(saveaspng = FALSE),
                      opts_hover(css = "fill-opacity: 1; stroke:white; stroke-opacity: 1; r: 2.5pt;")
                      ))

```
</div>

</div>
