---
title: "CENSUS 2021: Housing"
lang: "en-GB"
output:
  html_document:
    highlight: null
    mathjax: null
    theme: flatly
    css: styles.css
    self_contained: TRUE
    toc: TRUE
    toc_depth: 2
    toc_float: true
    df_print: paged
    includes:
      in_header: head_includes.html
---
<main>
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
library(tidyverse) ;
library(sf) ;
library(RColorBrewer) ;
library(kableExtra); 
library(httr) ; library(readxl)
library(scales) ; 
library(ggiraph)
library(ggpol)
library(ggtext)

source("https://github.com/traffordDataLab/assets/raw/master/theme/ggplot2/theme_lab.R")

`%out%` <- function(a,b) ! a %in% b

```


The [CENSUS 2021](https://census.gov.uk) in England and Wales published data about [housing](https://www.ons.gov.uk/releases/housingcensus2021inenglandandwales). The release included three publications: [People with second addresses](https://www.ons.gov.uk/peoplepopulationandcommunity/housing/bulletins/peoplewithsecondaddressesenglandandwales/census2021), [Housing](https://www.ons.gov.uk/peoplepopulationandcommunity/housing/bulletins/housingenglandandwales/census2021) and [Communal establishment residents](https://www.ons.gov.uk/peoplepopulationandcommunity/housing/bulletins/communalestablishmentresidentsenglandandwales/census2021).

## Central Heating

In Trafford, 98.8% (95,107) of households have central heating whilst the remaining 1.2% (1,160) of households do not have central heating. The most common type of central heating in Trafford's households is by far "Mains gas only" (81.9%, 78,873).

In Trafford, 139 (0.1%) households have a central heating that only uses renewable energy. An additional 217 households (0.2%) use renewable energy alongside other type of central heating.

```{r}

lookup <- read_csv("https://houseofcommonslibrary.github.io/msoanames/MSOA-Names-Latest.csv") %>%
  filter(Laname=="Trafford") %>% 
  select(msoa11nm,msoa11hclnm)

join_MSOA_names <- function(lookup,df){
  left_join(df, lookup %>% select(msoa11nm,msoa11hclnm), by = c(area_name = "msoa11nm")) %>%
  mutate(area_name = msoa11hclnm) %>%
  select(-msoa11hclnm) %>%
  mutate(area_name = ifelse(is.na(area_name),"Trafford", area_name)) 
}

central_heating_2011 <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_547_1.data.csv?date=latest&geography=1946157089&rural_urban=0&cell=0...7&measures=20100") %>%
   select(date = DATE, area_name = GEOGRAPHY_NAME, category = CELL_NAME, measure = MEASURES_NAME, value = OBS_VALUE) %>% 
  mutate(Percent = round(value *100/value[1],1))

central_heating_2021 <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_2064_1.data.csv?date=latest&geography=645922849,637535406...637535433,2092957699&c2021_heating_13=0...12&measures=20100,20301") %>%
   select(date = DATE, area_name = GEOGRAPHY_NAME, category = C2021_HEATING_13_NAME, measure = MEASURES_NAME, value = OBS_VALUE)

central_heating_Traf <- central_heating_2021 %>%
  filter(area_name == "Trafford", category != "Total: All households") %>%
  pivot_wider(names_from = measure,values_from = value) %>%
  mutate(category = case_when(category == "District or communal heat networks only" ~ "Heat networks only",
                              category == "Two or more types of central heating (including renewable energy)" ~ "***Two or more types(IR)",
                              category == "Two or more types of central heating (not including renewable energy)" ~ "**Two or more types(NIR)",
                              category == "Tank or bottled gas only" ~ "Tank or bottled gas only",
                              category == "Renewable energy only"~ "Renewable energy only",
                              category == "Other central heating only"~ "Other central heating only",
                              category == "Mains gas only"~ "*Mains gas only",
                              TRUE ~ category))
```

```{r fig.height=6}
ggplot(central_heating_Traf, aes(x = fct_reorder(category, Value), y = Value)) +
  geom_col(fill = "#5d77a3") +
  geom_text(aes(y = 0, label = paste0(category, ": ", format(Value, big.mark=","), ", ", Percent, "%")), 
            hjust = 1, size = 3, colour = "#212121") +
  labs(x = NULL, y = NULL,
       title = "Central Heating",
       subtitle = "Trafford 2021",
       caption = "* Bar is not presented\n** Not including renewable energy (NIR), *** Including renewable energy(IR).\nSource: Census 2021 | @traffordDataLab",
       fill = NULL) +
  theme_lab() +
  theme(panel.grid.major.y = element_blank(),
        plot.title = element_text(size = 15),
        plot.subtitle = element_text(size = 12),
        plot.caption = element_text(size = 8),
        axis.text.y = element_blank(),
        axis.text.x = element_blank()
        ) +
  coord_polar(theta = "y") +
  ylim(0, 10000) 
```

Trafford has a higher proportion of households with “Mains gas only” central heating, when compared to the mean of 15 similar authorities, Greater Manchester and England. For most of all other central heating categories, the proportion of households in Trafford is lower  when compared to the mean of similar authorities, Greater Manchester and England.

Trafford has a 0.3 % of households using at least one renewable energy source for central heating, while the mean of similar authorities is more than the double at 0.7% and England's percentage (0.9%) is three times that of Trafford.

```{r ch_trafCIPFA}

cipfa <- read_csv("https://www.traffordDataLab.io/corporate_plan/data/cipfa2021.csv")

gm <- read_csv ("https://www.traffordDataLab.io/spatial_data/lookups/administrative_lookup.csv") %>%
  select(area_name = lad17nm, area_code = lad17cd) %>%
  unique()

gm_cipfa <- cipfa %>%
  bind_rows(gm) %>%
  unique()

cen_heat_2021_raw <- read_csv(paste0("https://www.nomisweb.co.uk/api/v01/dataset/NM_2064_1.data.csv?date=latest&geography=",paste(c("E92000001",gm_cipfa$area_code), collapse = ','),"&c2021_heating_13=0...12&measures=20100,20301")) %>%
  unique() %>%
   select(date = DATE, area_name = GEOGRAPHY_NAME, category = C2021_HEATING_13_NAME, measure = MEASURES_NAME, value = OBS_VALUE) 

cen_heat_2021_cipfa <- cen_heat_2021_raw %>%
  filter(measure == "Percent") %>%
  filter(area_name %in% cipfa$area_name) %>%
  select(category,value) %>%
  group_by(category) %>%
  summarise_all(mean) %>%
  mutate(Percent = round(value,1)) %>%
  mutate(area_name = "CIPFA mean")

cen_heat_gm <- cen_heat_2021_raw %>%
  filter(measure == "Value") %>%
  filter(area_name %in% gm$area_name) %>%
  select(category,value) %>%
  group_by(category) %>%
  summarise_all(sum) %>%
  mutate(`Percent` = round(value*100/value[10],1)) %>%
  mutate(area_name = "Greater Manchester")

cen_heat_Traff <- cen_heat_2021_raw %>%
  #filter(category %in% c("No central heating", "Electric only", "Renewable energy only"))  %>%
  filter(measure == "Percent") %>%
  filter(area_name %in% c("Trafford", "England")) %>%
  select(area_name, category, Percent = value)

cen_heat_4 <- bind_rows(cen_heat_2021_cipfa, cen_heat_gm,cen_heat_Traff)
  
```

<div class = "row">
<div class = "col-md-12">
<div class = "row">
<div class = "col-md-7">

```{r plotBin, fig.height=4}
cen_heat_plot <- cen_heat_4 %>%
  filter(category != "Total: All households") %>%
  mutate(category = case_when(category == "Mains gas only" ~ category,
                               category == "No central heating" ~ category,
                               category == "Electric only" ~ category,
                               TRUE ~ "Other central heating"
                               )) %>%
  mutate(area_name = case_when(area_name == "CIPFA mean" ~ "Similar Authorities",
                               area_name == "Greater Manchester" ~ "GM",
                               TRUE ~ area_name
                               )) %>%
  group_by(area_name, category) %>%
  summarise(Percent = sum(Percent)) %>%
  mutate(area_name = factor(area_name, levels = c("Trafford", "Similar Authorities", "GM", "England"))) %>%
  mutate(category = factor(category, levels = c("No central heating", "Other central heating", "Electric only", "Mains gas only")))
  

ggplot() +
  geom_col(data = cen_heat_plot %>% filter(area_name == "Trafford"), aes(Percent, category), fill = "#902082") +
  geom_errorbar(data = cen_heat_plot %>% filter(area_name != "Trafford"),  aes(x=Percent, xmax=Percent, xmin=Percent, y = category, color = area_name), size = .7) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 87), labels = function(x) paste0(x, "%")) +
  scale_color_manual(values = c("#5d77a3", "black", "grey")) +
  labs(x = NULL, y = NULL, title = "Central Heating", subtitle = "Trafford 2021",
       caption = NULL) +
  theme_lab() +
  theme(plot.title = element_text(size=20),
        plot.subtitle = element_markdown(size=17),
        plot.title.position = "plot",
        plot.margin = unit(c(0,0,0,0), "cm"),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(hjust = 0, size=14),
        axis.text.x = element_text(size=14),
        axis.line.y = element_line(colour = "#000000"),
        legend.text = element_text(size=14)) +
  guides(color = guide_legend(nrow = 1, title=""))

```
</div>
<br>
<div class = "col-md-5  smtable">
<br>

```{r tableBin}
cen_heat_plot %>%
  pivot_wider(names_from = "area_name", values_from = "Percent") %>%
  mutate(`Similar Authorities` = paste0(`Similar Authorities`,"%"), England = paste0(England,"%"),
         `GM` = paste0(`GM`,"%"),
          `Trafford` = paste0(`Trafford`,"%")) %>%
  select(category, Trafford, `Similar Authorities`, `GM`, `England`) %>%
  arrange(factor(category, levels = c("Mains gas only", "Electric only", "Other central heating", "No central heating")) ) %>%
  kable(col.names = c("", "Trafford", "Similar Authorities", "Greater Manchester", "England")) %>%
  kable_styling(font_size = 12, bootstrap_options = "none") %>%
  row_spec(0, bold = T, color = "#757575")
```
</div>
</div>
<div class = "row">
<div class = "col-md-7">
```{r plotLes, fig.height=6}
cen_heat_plot2 <- cen_heat_4 %>%
  filter(category %out% c("Total: All households", "Mains gas only", "Electric only" )) %>%
  mutate(category = case_when(category == "District or communal heat networks only" ~ "District or communal\nheat networks only",
                              category == "Two or more types of central heating (including renewable energy)" ~ "Two or more types\n(including renewable)",
                              category == "Two or more types of central heating (not including renewable energy)" ~ "Two or more types (not\nincluding renewable)",
                              category == "Tank or bottled gas only" ~ "Tank or bottled gas\nonly",
                              category == "Renewable energy only"~ "Renewable energy\nonly",
                              category == "Other central heating only"~ "Other central heating\nonly",
                              TRUE ~ category)) %>%
  mutate(area_name = factor(area_name, levels = c("Trafford", "CIPFA mean", "Greater Manchester", "England"))) %>%
  mutate(category = reorder(category, ifelse(area_name == "Trafford", Percent, NA), na.rm = TRUE))
  

ggplot() +
  geom_col(data = cen_heat_plot2 %>% filter(area_name == "Trafford"), aes(Percent, category), fill = "#902082") +
  geom_errorbar(data = cen_heat_plot2 %>% filter(area_name != "Trafford"),  aes(x=Percent, xmax=Percent, xmin=Percent, y = category, color = area_name), size = .7) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 8.7), labels = function(x) paste0(x, "%")) +
  scale_color_manual(values = c("#5d77a3", "black", "grey")) +
  labs(x = NULL, y = NULL, title = NULL, subtitle = "Excluding Gas and Electric",
       caption = NULL) +
  theme_lab() +
  theme(plot.title = element_text(size=20),
        plot.subtitle = element_markdown(size=16),
        plot.margin = unit(c(0,0,0,0), "cm"),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(hjust = 0, size=14),
        axis.text.x = element_text(size=14),
        axis.line.y = element_line(colour = "#000000"),
        legend.position = "none") 
```
</div>
<div class = "col-md-5  smtable">

```{r tableLes}

cen_heat_plot2 %>%
  select(-value) %>%
  pivot_wider(names_from = "area_name", values_from = "Percent") %>%
  mutate(`CIPFA mean` = paste0(`CIPFA mean`,"%"), England = paste0(England,"%"),
         `Greater Manchester` = paste0(`Greater Manchester`,"%"),
          `Trafford` = paste0(`Trafford`,"%")) %>%
  select(category, Trafford, `CIPFA mean`, `Greater Manchester`, `England`) %>%
  arrange(desc(factor(category, levels = levels(cen_heat_plot2$category)))) %>%
  kable(col.names = c("", "T*", "S A*", "GM*", "E*")) %>%
  kable_styling(font_size = 12, bootstrap_options = "none") %>%
  row_spec(0, bold = T, color = "#757575") %>%
  column_spec(2:5, width = "50px")
```
<p class = "TableCaption"> T* = Trafford,  S A* = Similar Authorities (CIPFA 2021),  GM* = Greater Manchester and E* = England<p>
</div>
</div>
</div>
</div>

<br>
The Trafford's MSOAs with the highest proportion of households with No central heating was Old Trafford with 2.1% (100 households) Gorse Hill with 1.9% (70 households), Partington with 1.8% (60 households) and Sale Central with 1.7% (73 households).

```{r}

lookup <- read_csv("https://houseofcommonslibrary.github.io/msoanames/MSOA-Names-Latest.csv") %>%
  filter(Laname=="Trafford") %>% 
  select(msoa11nm,msoa11hclnm)


join_MSOA_names <- function(lookup,df){
  left_join(df, lookup %>% select(msoa11nm,msoa11hclnm), by = c(area_name = "msoa11nm")) %>%
  mutate(area_name = msoa11hclnm) %>%
  select(-msoa11hclnm) %>%
  mutate(area_name = ifelse(is.na(area_name),"Trafford", area_name)) 
}

girafe_options <- list(opts_tooltip(use_fill = FALSE, opacity = 1, css = "background-color: #e7e6e1; color: #212121; padding: 0.1em; border-radius: 0.25em;"),
                      opts_toolbar(saveaspng = FALSE),
                      opts_hover(css = "fill-opacity: 1; stroke:white; stroke-opacity: 1; r: 2.5pt;")
                      )

msoa_sf <- st_read("https://www.traffordDataLab.io/spatial_data/msoa/2021/trafford_msoa_generalised.geojson", quiet = TRUE) %>%
    left_join(lookup, by = c(area_name = "msoa11nm")) %>%
  mutate(area_name = msoa11hclnm) %>%
  select(-msoa11hclnm)

CH_msoa <- central_heating_2021 %>%
  pivot_wider(names_from = "measure", values_from = "value") %>%
  join_MSOA_names(lookup,.) %>%
  filter(area_name != "Trafford") %>%
  mutate(tooltip = paste0("<strong>", area_name,"</strong><br/>",
      "<strong>", category,"</strong>", format(Value, big.mark=","), " households<br/>",
    "<strong>", Percent, "</strong>% of households"))

msoa_sf_central_heating <- msoa_sf %>%
  left_join(CH_msoa, by = "area_name")

```

<div class = "row">
<div class = "col-md-7">

```{r}

NCH_plot <- CH_msoa %>% 
  filter(category == "No central heating") %>%
  arrange(Value) %>%
  mutate(area_name = factor(area_name, levels = area_name)) 

gg <- ggplot() +
  geom_point_interactive(data = NCH_plot, aes(Value, area_name, tooltip = tooltip, color = Percent), size = 3 , color = "#48327F") +
  scale_x_continuous(limits = c(0,100)) +
    labs(x = "Households", y = NULL, title = "No central heating", subtitle = "Trafford MSOAs, 2021", caption = "", colour = NULL) +
  theme_lab() +
  theme(plot.title = element_text(size=17),
        plot.title.position = "plot",
        plot.margin = unit(c(0,0,0,0), "cm"),
        plot.subtitle = element_text(size=14),
        plot.caption = element_text(size=10, hjust = 1),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(hjust = 0, size=10),
        axis.title.x = element_text(size=10),
        axis.text.x = element_text(size=10))
  
girafe(ggobj = gg, height_svg = 6,
       options = girafe_options)

```

</div>
<div class = "col-md-5">
```{r}

gg <- ggplot(msoa_sf_central_heating %>% filter(category == "No central heating")) +
  geom_sf_interactive(aes(tooltip = tooltip,
              fill = Percent), color = "#FFFFFF", size = 0.5, alpha = 1) +
   scale_fill_gradient(high = "#48327F",
                             low = "#9FBBD9",
                             na.value = "grey50",
                       n.breaks = 5,
                       breaks = waiver(),
                       guide = guide_legend(keyheight = unit(4, units = "mm"),
                                             keywidth=unit(16, units = "mm"),
                                             label.position = "bottom",
                                             title = "% of households in the MSOA",
                                             title.position = 'top',
                                             nrow = 1,
                                            aesthetics = "fill")) +
  coord_sf(crs = st_crs(4326), datum = NA) +
  theme_lab() +
      labs(x = NULL, y = NULL,
       title = "",
       subtitle = "",
       caption = "\n\n\nContains OS data ©; Crown copyright and database right 2022\nSource: Census 2021 |  @traffordDataLab") + 
  theme(plot.title = element_text(size=19),
        plot.subtitle = element_text(size=17),
        plot.caption = element_text(size=14, hjust = 1),
        plot.margin = unit(c(0,0,0,0), "cm"),
        legend.title = element_text(size=12),
        legend.text = element_text(size=12),
        legend.position = "bottom") 

girafe(ggobj = gg, height_svg = 9,
       options = girafe_options)


```
</div>
</div>




## Accommodation type 

According to the Census 2021, 43.8% (42,193) of households in Trafford reported to live in a semi-detached property, which is more than the double of any other type of accommodation in Trafford. Terraced (20.8%, 19,976), Flats in a purpose-built block (16.9%, 16,236) and detached (15.2%, 14,601) constitute most of the rest of the accommodation properties.

Trafford had a larger proportion of semi-detached properties when compared to the mean of 15 similar authorities (9.1% more), Greater Manchester (5.9% more) and England (12.3 more). The proportion of terraced houses was smaller and the proportion of flats was similar when compared to all comparators. Trafford had a similar proportion of detached houses to Greater Manchester but a smaller proportion compared to  the mean of  similar authorities.

<div class = "row">
<div class = "col-md-9">

```{r}

accom_type_2021 <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_2062_1.data.csv?date=latest&geography=645922849&c2021_acctype_9=0...8&measures=20100,20301") %>%
    select(date = DATE, area_name = GEOGRAPHY_NAME, category = C2021_ACCTYPE_9_NAME, measure = MEASURES_NAME, value = OBS_VALUE)

accom_typeTraf_2021 <- read_csv(paste0("https://www.nomisweb.co.uk/api/v01/dataset/NM_2062_1.data.csv?date=latest&geography=",paste(c("E92000001",gm_cipfa$area_code), collapse = ','),"&c2021_acctype_9=0...8&measures=20100,20301")) %>%
   select(date = DATE, area_name = GEOGRAPHY_NAME, category = C2021_ACCTYPE_9_NAME, measure = MEASURES_NAME, value = OBS_VALUE) 

accom_type2021_cipfa <- accom_typeTraf_2021 %>%
  filter(measure == "Percent") %>%
  filter(area_name %in% cipfa$area_name) %>%
  select(category,value) %>%
  group_by(category) %>%
  summarise(Percent = mean(value)) %>%
  mutate(Percent = round(Percent,1)) %>%
  mutate(area_name = "CIPFA mean")

accom_typegm <- accom_typeTraf_2021 %>%
  filter(measure == "Value") %>%
  filter(area_name %in% gm$area_name) %>%
  select(category,value) %>%
  group_by(category) %>%
  summarise(value = sum(value)) %>%
  mutate(`Percent` = round(value*100/value[9],2)) %>%
  mutate(area_name = "Greater Manchester") %>%
  rename(Value = value)

accom_typeTraff <- accom_typeTraf_2021 %>%
  #filter(category %in% c("No central heating", "Electric only", "Renewable energy only"))  %>%
  #filter(measure == "Percent") %>%
  filter(area_name %in% c("Trafford", "England")) %>%
  select(-date) %>%
  pivot_wider(names_from = "measure", values_from = "value")

accom_type4 <- bind_rows(accom_typeTraff, accom_type2021_cipfa, accom_typegm)

```

```{r plotAT, fig.height=5}
accom_type4_plot <- accom_type4 %>%
  filter(category != "Total: All households") %>%
  mutate(category = case_when(category == "Part of a converted or shared house, including bedsits" ~ "Part of a converted or shared house,\nincluding bedsits",
                              category == "Part of another converted building, for example, former school, church or warehouse" ~ "***Part of another converted building",
                              category == "In a commercial building, for example, in an office building, hotel or over a shop" ~ "**In a commercial building",
                              category == "In a purpose-built block of flats or tenement" ~ "*Flats",
                               TRUE ~ category
                               )) %>%
  mutate(area_name = case_when(area_name == "CIPFA mean" ~ "Similar Authorities",
                               area_name == "Greater Manchester" ~ "GM",
                               TRUE ~ area_name
                               )) %>%
  mutate(area_name = factor(area_name, levels = c("Trafford", "Similar Authorities", "GM", "England"))) %>%
  mutate(category = reorder(category, ifelse(area_name == "Trafford", Percent, NA), na.rm = TRUE))
  

ggplot() +
  geom_col(data = accom_type4_plot %>% filter(area_name == "Trafford"), aes(Percent, category), fill = "#5d77a3") +
  geom_errorbar(data = accom_type4_plot %>% filter(area_name != "Trafford"),  aes(x=Percent, xmax=Percent, xmin=Percent, y = category, color = area_name), size = .7) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 45), labels = function(x) paste0(x, "%")) +
  scale_color_manual(values = c("#902082", "black", "grey")) +
  labs(x = NULL, y = NULL, title = "Accomodation type", subtitle = "Trafford 2021",
       caption = NULL) +
  theme_lab() +
  theme(plot.title = element_text(size=16),
        plot.subtitle = element_markdown(size=14),
        plot.title.position = "plot",
        plot.margin = unit(c(0,0,0,0), "cm"),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(hjust = 1, size=11),
        axis.text.x = element_text(size=11),
        axis.line.y = element_line(colour = "#000000"),
        legend.text = element_text(size=11)) +
  guides(color = guide_legend(nrow = 1, title=""))

```
</div>
</div>
<br>

<div class = "row">
<div class = "col-md-9">

```{r}
accom_type4_plot %>%
  select(-Value) %>%
  pivot_wider(names_from = "area_name", values_from = "Percent") %>%
  left_join(accom_type4_plot %>% filter(area_name == "Trafford") %>% select(category, Value), by = "category") %>%
  mutate(`Similar Authorities` = paste0(`Similar Authorities`,"%"), England = paste0(England,"%"),
         `GM` = paste0(`GM`,"%"),
          `Trafford` = paste0(`Trafford`,"% (", format(Value, big.mark=","),")")) %>%
  select(category, Trafford, `Similar Authorities`, `GM`, `England`) %>%
  arrange(desc(factor(category, levels = levels(accom_type4_plot$category)))) %>%
  kable(col.names = c("", "Trafford", "Similar Authorities", "Greater Manchester", "England")) %>%
  kable_styling(font_size = 12, bootstrap_options = "none") %>%
  row_spec(0, bold = T, color = "#757575")

```
</div>
</div>

```{r}

accType_2011 <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_618_1.data.csv?date=latest&geography=1946157089&rural_urban=0&cell=7...13&measures=20100,20301") %>%
  select(date = DATE, area_name = GEOGRAPHY_NAME, category = CELL_NAME, measure = MEASURES_NAME, value = OBS_VALUE)

accType2011 <- accType_2011 %>%
  mutate(category = sub(".*: ", "", category)) %>%
    filter(category != "Total: All households") %>%
  mutate(category = case_when(category == "Part of a converted or shared house (including bed-sits)" ~ "Part of a converted or shared house,\nincluding bedsits",
                              category == "Terraced (including end-terrace)" ~ "Terraced",
                              category == "In a commercial building" ~ "**In a commercial building",
                              category == "Purpose-built block of flats or tenement" ~ "*Flats",
                              category == "Caravan or other mobile or temporary structure" ~ "A caravan or other mobile or temporary structure",
                               TRUE ~ category
                               )) %>%
  pivot_wider(names_from = "measure", values_from = "value")
  

accType <- accom_type4_plot %>%
  filter(area_name == "Trafford") %>% 
  mutate(date=2021) %>%
  bind_rows(accType2011) %>%
  pivot_wider(names_from = date, values_from = c(Value,Percent)) %>%
    mutate(`Difference (%)` = round(Percent_2021 - Percent_2011,1), Difference = Value_2021 - Value_2011) %>%
  mutate(category = fct_reorder(factor(category), Percent_2021)) %>%
  mutate(tooltip = paste0("<strong>", area_name,"</strong><br/>",
                          "<strong>", category,"</strong> households<br/>",
      "<strong>2011: </strong>", Percent_2011, "% (", format(Value_2011, big.mark=","), ")<br/>",
      "<strong>2021: </strong>", Percent_2021, "% (", format(Value_2021, big.mark=","), ")<br/>",
    "<strong>Difference from 2011: </strong>", `Difference (%)`, "% (", Difference, ")<br/>"
    ))

```

<div class = "row">
<div class = "col-md-9">
```{r}
gg <- ggplot() +
  geom_col_interactive(data = accType, aes(Percent_2021,category, tooltip = tooltip), fill = "#902082") +
  geom_errorbar(data = accType,  aes(x=Percent_2011, xmax=Percent_2011, xmin=Percent_2011, y = category), color = "#5d77a3", size = 0.7) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 45), labels = function(x) paste0(x, "%")) +
  labs(x = NULL, y = NULL, title = "Accomodation Type", subtitle = "<span style = 'color:#5d77a3;'>2011</span> and <span style = 'color:#902082;'>2021</span>",
       caption = NULL) +
  theme_lab() +
  theme(plot.title = element_text(size=14),
        plot.subtitle = element_markdown(size=12),
        plot.title.position = "plot",
        plot.margin = unit(c(0,0,0,0), "cm"),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(hjust = 1, size=10),
        axis.text.x = element_text(size=10),
        axis.line.y = element_line(colour = "#000000")) +
  guides(color = guide_legend(nrow = 1))

girafe(ggobj = gg, height_svg = 4,
       options = girafe_options)

```
</div>
</div>

<p class = "TableCaption">\*In a purpose-built block of flats or tenement. \** For example, in an office building, hotel or over a shop. \***For example, former school, church or warehouse (category added in 2021).<br>Source: Census 2021 | @traffordDataLab</p>

## Tenure

According to the Census 2021, 69% (66,387) of households in Trafford own the house they live in, 15.3% (14,744)  rent privately, and 15% (14,419) rent their house from a social landlord.

In 2021, Trafford had a larger proportion of households that owned the house they lived in when compared to the average of 15 similar local authorities as well as Greater Manchester and England. This applies to both types of ownership: with a mortgage or loan, and outright. 

Consequently, Trafford had a lower proportion of households that rented the house they lived in, when compared to the average of 15 similar local authorities, Greater Manchester and England. 

```{r}

tenure_Traf_2021 <- read_csv(paste0("https://www.nomisweb.co.uk/api/v01/dataset/NM_2072_1.data.csv?date=latest&geography=",paste(c("E92000001",gm_cipfa$area_code), collapse = ','),"&c2021_tenure_9=0...2,1002...1004,8&measures=20100,20301")) %>%
   select(date = DATE, area_name = GEOGRAPHY_NAME, category = C2021_TENURE_9_NAME, measure = MEASURES_NAME, value = OBS_VALUE) %>%
  mutate(category = sub(".*: ", "", category))

tenure_2021_cipfa <- tenure_Traf_2021 %>%
  filter(measure == "Percent") %>%
  filter(area_name %in% cipfa$area_name) %>%
  select(category,value) %>%
  group_by(category) %>%
  summarise(Percent = mean(value)) %>%
  mutate(Percent = round(Percent,1)) %>%
  mutate(area_name = "CIPFA mean")

tenure_gm <- tenure_Traf_2021 %>%
  filter(measure == "Value") %>%
  filter(area_name %in% gm$area_name) %>%
  select(category,value) %>%
  group_by(category) %>%
  summarise_all(sum) %>%
  mutate(`Percent` = round(value*100/value[1],2)) %>%
  mutate(area_name = "Greater Manchester") %>%
  rename(Value = value)

tenure_Traff <- tenure_Traf_2021 %>%
  #filter(category %in% c("No central heating", "Electric only", "Renewable energy only"))  %>%
  #filter(measure == "Percent") %>%
  filter(area_name %in% c("Trafford", "England")) %>%
  select(-date) %>%
  pivot_wider(names_from = "measure", values_from = "value")

tenure_4 <- bind_rows(tenure_Traff, tenure_2021_cipfa, tenure_gm)
```

<div class = "row">
<div class = "col-md-6">

```{r plotTR, fig.height=6}
tenure_plot <- tenure_4 %>%
  filter(category != "All households") %>%
  mutate(category = case_when(category == "Owns with a mortgage or loan" ~ "Owns with\na mortgage or loan",
                               TRUE ~ category
                               )) %>%
  mutate(area_name = case_when(area_name == "CIPFA mean" ~ "Similar Authorities",
                               area_name == "Greater Manchester" ~ "GM",
                               TRUE ~ area_name
                               )) %>%
  mutate(area_name = factor(area_name, levels = c("Trafford", "Similar Authorities", "GM", "England"))) %>%
  mutate(category = reorder(category, ifelse(area_name == "Trafford", Percent, NA), na.rm = TRUE))
  

ggplot() +
  geom_col(data = tenure_plot %>% filter(area_name == "Trafford"), aes(Percent, category), fill = "#5d77a3") +
  geom_errorbar(data = tenure_plot %>% filter(area_name != "Trafford"),  aes(x=Percent, xmax=Percent, xmin=Percent, y = category, color = area_name), size = .7) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 35), labels = function(x) paste0(x, "%")) +
  scale_color_manual(values = c("#902082", "black", "grey")) +
  labs(x = NULL, y = NULL, title = "Tenure", subtitle = "Trafford 2021",
       caption = NULL) +
  theme_lab() +
  theme(plot.title = element_text(size=28),
        plot.subtitle = element_markdown(size=22),
        plot.title.position = "plot",
        plot.margin = unit(c(0,0,0,0), "cm"),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(hjust = 0, size=16),
        axis.text.x = element_text(size=16),
        axis.line.y = element_line(colour = "#000000"),
        legend.text = element_text(size=16)) +
  guides(color = guide_legend(nrow = 1, title=""))

```
</div>
<br>
<div class = "col-md-6  smtable">
<br>
```{r tableTR}
tenure_plot %>%
  select(-Value) %>%
  pivot_wider(names_from = "area_name", values_from = "Percent") %>%
  left_join(tenure_plot %>% filter(area_name == "Trafford") %>% select(category, Value), by = "category") %>%
  mutate(`Similar Authorities` = paste0(`Similar Authorities`,"%"), England = paste0(England,"%"),
         `GM` = paste0(`GM`,"%"),
          `Trafford` = paste0(`Trafford`,"% (", format(Value, big.mark=","),")")) %>%
  select(category, Trafford, `Similar Authorities`, `GM`, `England`) %>%
  arrange(desc(factor(category, levels = levels(tenure_plot$category)))) %>%
  kable(col.names = c("", "Trafford", "Similar Authorities", "Greater Manchester", "England")) %>%
  kable_styling(font_size = 12, bootstrap_options = "none") %>%
  row_spec(0, bold = T, color = "#757575")
```
</div>
</div>

```{r}

tenure_2011 <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_619_1.data.csv?date=latest&geography=1946157089&rural_urban=0&cell=0...3,200,300,8&measures=20100,20301") %>%
  select(date = DATE, area_name = GEOGRAPHY_NAME, category = CELL_NAME, measure = MEASURES_NAME, value = OBS_VALUE)

tenure2011 <- tenure_2011 %>%
  mutate(category = sub(".*: ", "", category)) %>%
    filter(category != "All households") %>%
  mutate(category = case_when(category == "Owned with a mortgage or loan" ~ "Owns with\na mortgage or loan",
                              category == "Shared ownership (part owned and part rented)" ~ "Shared ownership",
                              category == "Owned outright" ~ "Owns outright",
                              category == "Living rent free" ~ "Lives rent free",
                               TRUE ~ category
                               )) %>%
  #mutate(category = sub("ing ", "es ", category)) %>%
  pivot_wider(names_from = "measure", values_from = "value")
  

tenure <- tenure_plot %>%
  filter(area_name == "Trafford") %>% 
  mutate(date=2021) %>%
  bind_rows(tenure2011) %>%
  pivot_wider(names_from = date, values_from = c(Value,Percent)) %>%
    mutate(`Difference (%)` = round(Percent_2021 - Percent_2011,1), Difference = Value_2021 - Value_2011) %>%
  mutate(category = fct_reorder(factor(category), Percent_2021)) %>%
  mutate(tooltip = paste0("<strong>", area_name,"</strong><br/>",
                          "<strong>", category,"</strong> households<br/>",
      "<strong>2011: </strong>", Percent_2011, "% (", format(Value_2011, big.mark=","), ")<br/>",
      "<strong>2021: </strong>", Percent_2021, "% (", format(Value_2021, big.mark=","), ")<br/>",
    "<strong>Difference from 2011: </strong>", `Difference (%)`, "% (", Difference, ")<br/>"
    ))

```

<div class = "row">
<div class = "col-md-9">
```{r}
gg <- ggplot() +
  geom_col_interactive(data = tenure, aes(Percent_2021,category, tooltip = tooltip), fill = "#902082") +
  geom_errorbar(data = tenure,  aes(x=Percent_2011, xmax=Percent_2011, xmin=Percent_2011, y = category), color = "#5d77a3", size = 0.7) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 45), labels = function(x) paste0(x, "%")) +
  labs(x = NULL, y = NULL, title = "Tenure", subtitle = "<span style = 'color:#5d77a3;'>2011</span> and <span style = 'color:#902082;'>2021</span>",
       caption = NULL) +
  theme_lab() +
  theme(plot.title = element_text(size=14),
        plot.subtitle = element_markdown(size=12),
        plot.title.position = "plot",
        plot.margin = unit(c(0,0,0,0), "cm"),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(hjust = 1, size=10),
        axis.text.x = element_text(size=10),
        axis.line.y = element_line(colour = "#000000")) +
  guides(color = guide_legend(nrow = 1))

girafe(ggobj = gg, height_svg = 3.5,
       options = girafe_options)

```
</div>
</div>



<br>

### Mortgage payers and private renters by Ward, Census 2021
<br>

```{r}

rent_mort <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_2072_1.data.csv?date=latest&geography=641728593...641728607,641728609,641728608,641728610...641728613&c2021_tenure_9=2,1004&measures=20100,20301") %>%
   select(date = DATE, area_name = GEOGRAPHY_NAME, category = C2021_TENURE_9_NAME, measure = MEASURES_NAME, value = OBS_VALUE) %>%
  mutate(category = sub(".*: ", "", category)) %>%
  mutate(area_name = sub(" \\(.*", "", area_name)) %>%
  pivot_wider(names_from = measure,values_from = value) %>%
  mutate(tooltip = paste0("<strong>", area_name,"</strong><br/>",
      "<strong>", category," : ", "</strong>", format(Value, big.mark=","), " residents<br/>",
    "<strong>", Percent, "</strong>% of residents"))

ward_sf <- st_read("https://www.traffordDataLab.io/spatial_data/ward/2022/trafford_ward_generalised.geojson", quiet = TRUE)

ward_sf_rent_mort <-ward_sf %>%
  left_join(rent_mort, by = "area_name")

```

<div class = "row">
<div class = "col-md-6">

```{r}

gg <- ggplot(ward_sf_rent_mort %>% filter(category == "Owns with a mortgage or loan")) +
  geom_sf_interactive(aes(tooltip = tooltip,
              fill = Percent), color = "#FFFFFF", size = 0.5, alpha = 1) +
   scale_fill_gradient(high = "#48327F",
                             low = "#9FBBD9",
                             na.value = "grey50",
                       n.breaks = 5,
                       breaks = waiver(),
                       guide = guide_legend(keyheight = unit(3, units = "mm"),
                                             keywidth=unit(14, units = "mm"),
                                             label.position = "bottom",
                                             title = "% of households in the Ward",
                                             title.position = 'top',
                                             nrow = 1,
                                            aesthetics = "fill")) +
  coord_sf(crs = st_crs(4326), datum = NA) +
  theme_lab() +
      labs(x = NULL, y = NULL,
       title = "Owns with a mortgage or loan",
       subtitle = NULL,
       caption = NULL) + 
  theme(plot.title = element_text(size=14),
        plot.subtitle = element_text(size=13),
        plot.caption = element_text(size=10, hjust = 1),
        plot.margin = unit(c(0,0,0,0), "cm"),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10),
        legend.position = "bottom") 

girafe(ggobj = gg, height_svg = 5,
       options = girafe_options)


```
</div>
<div class = "col-md-6">

```{r}

gg <- ggplot(ward_sf_rent_mort %>% filter(category == "Private rented")) +
  geom_sf_interactive(aes(tooltip = tooltip,
              fill = Percent), color = "#FFFFFF", size = 0.5, alpha = 1) +
   scale_fill_gradient(high = "#48327F",
                             low = "#9FBBD9",
                             na.value = "grey50",
                       n.breaks = 5,
                       breaks = waiver(),
                       guide = guide_legend(keyheight = unit(3, units = "mm"),
                                             keywidth=unit(14, units = "mm"),
                                             label.position = "bottom",
                                             title = "% of households in the Ward",
                                             title.position = 'top',
                                             nrow = 1,
                                            aesthetics = "fill")) +
  coord_sf(crs = st_crs(4326), datum = NA) +
  theme_lab() +
      labs(x = NULL, y = NULL,
       title = "Private rented ",
       subtitle = NULL,
       caption = NULL) + 
  theme(plot.title = element_text(size=14),
        plot.subtitle = element_text(size=13),
        plot.caption = element_text(size=10, hjust = 1),
        plot.margin = unit(c(0,0,0,0), "cm"),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10),
        legend.position = "bottom") 

girafe(ggobj = gg, height_svg = 5,
       options = girafe_options)


```
<p class = "TableCaption">Contains OS data ©; Crown copyright and database right 2022<br>Source: Census 2021 |  @traffordDataLab</p>
</div>
</div>




## Number of bedrooms

According to the Census 2021, 45.1% (43,420) of households in Trafford reported to live in a 3 bedroom property, which is almost the double of any other housing group by number of bedrooms in Trafford. The proportion of the rest of the housing properties were: 4 or more bedrooms 23.2% (22,365), 2 bedrooms 22.2% (21,354) and 1 bedroom 9.5% (9,130).

Trafford had a slightly larger proportion of 3 bedroom properties when compared to the mean of 15 similar authorities, Greater Manchester and England. Trafford had also a slightly larger proportion of 4 or more bedrooms houses to similar authorities and England and a 7.3% larger proportion of 4 or more bedrooms houses when compared to Greater Manchester. The proportion of 2 bedrooms houses was smaller than all comparators specially to Greater Manchester (8.35% less).

```{r}

bedrooms_Traf_2021 <- read_csv(paste0("https://www.nomisweb.co.uk/api/v01/dataset/NM_2068_1.data.csv?date=latest&geography=",paste(c("E92000001",gm_cipfa$area_code), collapse = ','),"&c2021_bedrooms_5=0...4&measures=20100,20301")) %>%
   select(date = DATE, area_name = GEOGRAPHY_NAME, category = C2021_BEDROOMS_5_NAME, measure = MEASURES_NAME, value = OBS_VALUE) 

bedrooms_2021_cipfa <- bedrooms_Traf_2021 %>%
  filter(measure == "Percent") %>%
  filter(area_name %in% cipfa$area_name) %>%
  select(category,value) %>%
  group_by(category) %>%
  summarise(Percent = mean(value)) %>%
  mutate(Percent = round(Percent,1)) %>%
  mutate(area_name = "CIPFA mean")

bedrooms_gm <- bedrooms_Traf_2021 %>%
  filter(measure == "Value") %>%
  filter(area_name %in% gm$area_name) %>%
  select(category,value) %>%
  group_by(category) %>%
  summarise_all(sum) %>%
  mutate(`Percent` = round(value*100/value[5],2)) %>%
  mutate(area_name = "Greater Manchester") %>%
  rename(Value = value)

bedrooms_Traff <- bedrooms_Traf_2021 %>%
  #filter(category %in% c("No central heating", "Electric only", "Renewable energy only"))  %>%
  #filter(measure == "Percent") %>%
  filter(area_name %in% c("Trafford", "England")) %>%
  select(-date) %>%
  pivot_wider(names_from = "measure", values_from = "value")

bedrooms_4 <- bind_rows(bedrooms_Traff, bedrooms_2021_cipfa, bedrooms_gm)
```

<div class = "row">
<div class = "col-md-6">

```{r plotBR, fig.height=5}
bedrooms_plot <- bedrooms_4 %>%
  filter(category != "Total: All households") %>%
  mutate(area_name = case_when(area_name == "CIPFA mean" ~ "Similar Authorities",
                               area_name == "Greater Manchester" ~ "GM",
                               TRUE ~ area_name
                               )) %>%
  mutate(area_name = factor(area_name, levels = c("Trafford", "Similar Authorities", "GM", "England"))) %>%
  mutate(category = reorder(category, ifelse(area_name == "Trafford", Percent, NA), na.rm = TRUE))
  

ggplot() +
  geom_col(data = bedrooms_plot %>% filter(area_name == "Trafford"), aes(Percent, category), fill = "#5d77a3") +
  geom_errorbar(data = bedrooms_plot %>% filter(area_name != "Trafford"),  aes(x=Percent, xmax=Percent, xmin=Percent, y = category, color = area_name), size = 1) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 46), labels = function(x) paste0(x, "%")) +
  scale_color_manual(values = c("#902082", "black", "grey")) +
  labs(x = NULL, y = NULL, title = "Number of bedrooms", subtitle = "Trafford 2021",
       caption = NULL) +
  theme_lab() +
  theme(plot.title = element_text(size=28),
        plot.subtitle = element_markdown(size=22),
        plot.title.position = "plot",
        plot.margin = unit(c(0,0,0,0), "cm"),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(hjust = 0, size=16),
        axis.text.x = element_text(size=16),
        axis.line.y = element_line(colour = "#000000"),
        legend.text = element_text(size=16)) +
  guides(color = guide_legend(nrow = 1, title=""))

```
</div>
<br>
<div class = "col-md-6  smtable">
<br>
```{r tableBR}
bedrooms_plot %>%
  select(-Value) %>%
  pivot_wider(names_from = "area_name", values_from = "Percent") %>%
  left_join(bedrooms_plot %>% filter(area_name == "Trafford") %>% select(category, Value), by = "category") %>%
  mutate(`Similar Authorities` = paste0(`Similar Authorities`,"%"), England = paste0(England,"%"),
         `GM` = paste0(`GM`,"%"),
          `Trafford` = paste0(`Trafford`,"% (", format(Value, big.mark=","),")")) %>%
  select(category, Trafford, `Similar Authorities`, `GM`, `England`) %>%
  arrange(desc(factor(category, levels = levels(bedrooms_plot$category)))) %>%
  kable(col.names = c("", "Trafford", "Similar Authorities", "Greater Manchester", "England")) %>%
  kable_styling(font_size = 12, bootstrap_options = "none") %>%
  row_spec(0, bold = T, color = "#757575")
```
</div>
</div>

## Bedroom occupancy

The Bedroom occupancy rating measure whether a household's accommodation is overcrowded, ideally occupied or under-occupied. This is calculated by comparing the number of bedrooms the household requires to the number of available bedrooms according to the Bedroom Standard.

An occupancy rating of -1 or less implies that a household's accommodation has fewer bedrooms than required (overcrowded). Likewise, an occupancy rating of +1 or more implies that a household's accommodation has more bedrooms than required (under-occupied). And finally,  an occupancy rating of 0 suggests that a household's accommodation has an ideal number of bedrooms.

According to the Census 2021, 73.5% (70,746) of households in Trafford were under-occupied and 2.9% (2,779) were overcrowded. Trafford had a higher proportion of under-occupied households when compared to the average of 15 similar local authorities, Greater Manchester and England. In contrast, Trafford had a lower proportion of overcrowded households than the average of 15 similar local authorities, Greater Manchester and England.

The MSOAs with a higher proportion of households living in overcrowded properties are Old Trafford and Firswood with 9.9% (473) and 7.3% (224) of households respectively. Old Trafford had 1.8% (86) of households requiring 2 or more bedrooms to achieve ideal occupancy.

In contrast, more than a third of Trafford's MSOAs had over 80% of households living in under-occupied properties. Timperley South, Bowdon, Hale, Ashton upon Mersey South, Timperley North and Hale Barns had over 50% of households living in properties with 2 or more spare rooms.

```{r}

br_occupancy_2021_raw <- read_csv(paste0("https://www.nomisweb.co.uk/api/v01/dataset/NM_2070_1.data.csv?date=latest&geography=",paste(c("E92000001",gm_cipfa$area_code), collapse = ','),"&c2021_occrat_bedrooms_6=0...5&measures=20100,20301")) %>%
  unique() %>%
   select(date = DATE, area_name = GEOGRAPHY_NAME, category = C2021_OCCRAT_BEDROOMS_6_NAME, measure = MEASURES_NAME, value = OBS_VALUE) %>%
  mutate(type = "Other")

br_occupancy_2021_MSOA <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_2070_1.data.csv?date=latest&geography=637535406...637535433&c2021_occrat_bedrooms_6=0...5&measures=20100,20301") %>%
   select(date = DATE, area_name = GEOGRAPHY_NAME, category = C2021_OCCRAT_BEDROOMS_6_NAME, measure = MEASURES_NAME, value = OBS_VALUE) %>%
  join_MSOA_names(lookup,.) %>%
  mutate(type = "MSOA") %>%
  bind_rows(br_occupancy_2021_raw %>% filter(area_name %in% c("Trafford", "England"))) %>%
  pivot_wider(names_from = measure, values_from = value) %>%
  select(-date)
  
br_occupancy_2021_cipfa <- br_occupancy_2021_raw %>%
  filter(measure == "Percent") %>%
  filter(area_name %in% cipfa$area_name) %>%
  select(category,value) %>%
  group_by(category) %>%
  summarise(Percent = mean(value)) %>%
  mutate(Percent = round(Percent,1)) %>%
  mutate(area_name = "Similar Authorities") %>%
  mutate(type = "Other")

br_occupancy_gm <- br_occupancy_2021_raw%>%
  filter(measure == "Value") %>%
  filter(area_name %in% gm$area_name) %>%
  select(category,value) %>%
  group_by(category) %>%
  summarise_all(sum) %>%
  mutate(`Percent` = round(value*100/value[6],1)) %>%
  mutate(area_name = "Greater Manchester") %>%
  rename(Value = value) %>%
  mutate(type = "Other")

br_occupancy_all <- br_occupancy_2021_MSOA %>%
  bind_rows(br_occupancy_2021_cipfa) %>%
  bind_rows(br_occupancy_gm) %>%
      mutate(category = case_when(category == "Occupancy rating of bedrooms: -2 or less" ~ "-2 or less (overcrowded)",
                              category == "Occupancy rating of bedrooms: -1" ~ "-1 (overcrowded)",
                              category == "Occupancy rating of bedrooms: 0" ~ "0 (ideal)",
                              category == "Occupancy rating of bedrooms: +1" ~ "+1 (under-occupied)",
                              category == "Occupancy rating of bedrooms: +2 or more"~ "+2 or more (under-occupied)",
                              TRUE ~ category))
for_commentary <- br_occupancy_all %>%
  mutate(category = case_when(str_detect(category, "overcrowded") ~ "overcrowded",
                               str_detect(category, "under-occupied") ~ "under-occupied",
                               TRUE ~ category)) %>%
  select(-type) %>%
  group_by(area_name, category) %>%
  summarise(Percent = sum(Percent), Value = sum(Value))
  
```

<div class = "row">
<div class = "col-md-12">

```{r}

plot_bo <- br_occupancy_all %>%
  mutate(tooltip = paste0("<strong>", area_name,"</strong><br/>",
                          "<strong>Rating: </strong>", category, "<br/>",
      "<strong>", "% Households: </strong>", Percent, "% (", format(Value, big.mark=","), ")<br/>"
      )) %>%
  filter(category != "Total: All households") %>%
    mutate(area_name = fct_reorder(factor(area_name), ifelse(category == "-1 (overcrowded)", Percent, NA), na.rm = TRUE),
         area_name = fct_relevel(factor(area_name), "Trafford", "Similar Authorities", "Greater Manchester",  "England")) %>%
  mutate(category = factor(category, levels = c("-2 or less (overcrowded)", "-1 (overcrowded)", "0 (ideal)", "+1 (under-occupied)", "+2 or more (under-occupied)")))


gg <- ggplot(plot_bo, aes(area_name, Percent, fill = category, tooltip = tooltip)) + 
  geom_col_interactive(position = "stack", colour = "#757575", size = 0.2, alpha = 1) +
  scale_fill_manual(values = c("#37216B", "#53478C", "#bdbdbd", "#7987BA", "#9FBBD9"),
                     guide = guide_legend(keyheight = unit(4, units = "mm"),
                                             keywidth = unit(4, units = "mm"),
                                             label.position = "right",
                                             title = "% of households with\noccupancy rating:",
                                             title.position = 'top',
                                             ncol = 1,
                                            aesthetics = "fill")) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  facet_grid(type~., scales = "free_y", space = "free") +
    labs(title = "Bedroom Occupancy: Overcrowded or Under-occupied",
       subtitle = "Trafford MSOAs, 2021",
       caption = "Similar Authorities from CIPFA 2021\nSource: Census 2021  |  @traffordDataLab",
       x = NULL,
       y = NULL,
       fill = NULL) +
  coord_flip() +
    theme_lab() +
  theme(panel.grid.major.x = element_blank(),
        legend.position = "right",
        plot.title = element_text(size=12),
        plot.title.position = "plot",
        plot.margin = unit(c(0,0,0,0), "cm"),
        plot.subtitle = element_text(size=10),
        plot.caption = element_text(size=6, hjust = 1),
        legend.title = element_text(size=7),
        legend.text = element_text(size=7),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(hjust = 1, size=7),
        axis.text.x = element_text(size=7, angle = 90, vjust = 0.5, hjust=1),
        strip.text = element_blank()) 


girafe(ggobj = gg, height_svg = 5,
       options = girafe_options)

```
</div>
</div>


<br>


<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>

```{css}

.smtable {

padding-left: 0px;

}

.TableCaption {

font-size: 10px;

}

```

